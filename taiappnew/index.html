<script>
  const LOG_API_URL = "https://script.google.com/macros/s/AKfycbzuLkzL1YEh6Hv9aPOQGEYStOUH6TTO7P70gSY9c4aS5NFZ_tYy1_C0MVuvdhRkyHE_/exec";

  async function logVisit() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;

    // Lấy IP bằng service bên ngoài
    let ip = "unknown";
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      ip = data.ip;
    } catch {}

    await fetch(LOG_API_URL, {
      method: "POST",
      body: JSON.stringify({ ua, ip }),
      headers: { "Content-Type": "application/json" }
    });
  }

  function redirectToApp() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;

    const androidLink = "https://play.google.com/store/apps/details?id=vntaxi.namthang.passenger&pli=1";
    const iosLink = "https://apps.apple.com/vn/app/taxi-nam-th%E1%BA%AFng/id6475762518?l=vi";

    if (/android/i.test(ua)) {
      window.location.href = androidLink;
    } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
      window.location.href = iosLink;
    } else {
      document.getElementById("message").style.display = "block";
    }
  }

  // ✅ Khai báo async function
  window.onload = async () => {
    await logVisit();             // Ghi log trước
    setTimeout(redirectToApp, 500); // Sau 500ms thì redirect
  };
</script>
